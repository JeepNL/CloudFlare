@page "/twitter"
@using System.Net
@using System.Text.Json;
@inject ICookieService CookieService
@inject ILocalStorageService LocalStorageAsync
@inject NavigationManager NavMan
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@inject HttpClient _httpClient

<PageTitle>@pageTitle</PageTitle>
<HeadContent><meta name="description" content="@pageDesc" /></HeadContent>

<MudText Typo="Typo.h4">Twitter Utilities</MudText>
<MudText Class="mb-6" Typo="Typo.subtitle1">Preview</MudText>

<MudText Class="mb-4" Typo="Typo.body1">
    BlazorBits Twitter integration with <MudLink Href="https://twitter.com/JoeMayo" Target="_blank">Joe Mayo</MudLink>'s <MudLink Href="https://github.com/JoeMayo/LinqToTwitter" Target="_blank">LinqToTwitter</MudLink> library.
    When you click the button below you'll be redirected to the Twitter authentication page for external apps where you can allow BlazorBits access your Twitter account.
</MudText>

<MudText Class="mb-4" Typo="Typo.body1">
    Currently you'll only see some basic information about your Twitter account, but that will change in the near future, more functionality will follow soon.
</MudText>

@if (l2tUser is null)
{
    <MudButton Class="mt-4" OnClick="TwitterChallenge" Variant="Variant.Filled" Color="Color.Primary" Style="text-transform:none">Twitter authentication</MudButton>
}
else
{
    <MudSimpleTable Dense=true Striped=true Bordered=false Style="overflow-x: auto;">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>IdStr</td><td>@l2tUser.IdStr</td></tr>
            <tr><td>Name</td><td>@l2tUser.Name</td></tr>
            <tr><td>ScreenName</td><td>@l2tUser.ScreenName</td></tr>
            <tr><td>ProfileImageUrlHttps</td><td>@l2tUser.ProfileImageUrlHttps</td></tr>
            <tr><td>Location</td><td>@l2tUser.Location</td></tr>
            <tr><td>Description</td><td>@l2tUser.Description</td></tr>
            <tr><td>Url</td><td>@l2tUser.Url</td></tr>
            <tr><td>Protected</td><td>@l2tUser.Protected</td></tr>
            <tr><td>CreatedAt</td><td>@l2tUser.CreatedAt</td></tr>
            <tr><td>FollowersCount</td><td>@l2tUser.FollowersCount</td></tr>
            <tr><td>FriendsCount</td><td>@l2tUser.FriendsCount</td></tr>
            <tr><td>ListedCount</td><td>@l2tUser.ListedCount</td></tr>
            <tr><td>StatusesCount</td><td>@l2tUser.StatusesCount</td></tr>
            <tr><td>FavouritesCount</td><td>@l2tUser.FavouritesCount</td></tr>
            <tr><td>Verified</td><td>@l2tUser.Verified</td></tr>
            <tr><td>Suspended</td><td>@l2tUser.Suspended</td></tr>
        </tbody>
    </MudSimpleTable>
}

@code {
    private string pageTitle = "Twitter | BlazorBits";
    private string pageDesc = "Twitter Utilities";
    L2TUser l2tUser;

    protected override async Task OnInitializedAsync()
    {
        l2tUser = await LocalStorageAsync.GetItemAsync<L2TUser>("_l2t");
        if (l2tUser is null)
        {
            string cookieValueB64 = await CookieService.GetValue("_l2t");
            if (!string.IsNullOrEmpty(cookieValueB64))
            {
                string cookieValueJson = Utils.FromB64(WebUtility.UrlDecode(cookieValueB64));
                l2tUser = JsonSerializer.Deserialize<L2TUser>(cookieValueJson);
                await LocalStorageAsync.SetItemAsync<L2TUser>("_l2t", l2tUser);
            }
        }
    }

    private void TwitterChallenge()
    {
        string backend = Configuration["Settings:BackEndUrl"];
        NavMan.NavigateTo($"https://{backend}/Twitter/Authenticate", true); // Server/Controllers/TwitterController.cs
    }
}
